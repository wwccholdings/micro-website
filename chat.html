<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat With Pete</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="/image/favicon.png">
  <style>
    :root {
      --frame-h: 90vh;
      --frame-ratio: 9 / 20;
    }

    /* Basic reset */
    *,
    *::after,
    *::before {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body,
    table,
    td,
    a {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    button {
      background-color: unset;
    }

    table,
    td {
      mso-table-lspace: 0pt;
      mso-table-rspace: 0pt;
    }

    img {
      -ms-interpolation-mode: bicubic;
    }

    body,
    html {
      font-family: 'Lora', Arial, sans-serif !important;
    }

    a {
      text-decoration: none;
    }

    /* custom classes */
    .main-wrapper {
      width: 100%;
      height: 100vh;
      background: linear-gradient(140deg, #617E93, #E1BDA7);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .mobile-frame {
      height: 90vh;
      max-height: 830px;
      width: auto;
      max-width: 100%;
      display: block;
      object-fit: contain;
      z-index: 1;
    }

    .img-wrapper {
      height: 90vh;
      max-height: 830px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .inner-page {
      position: absolute;
      top: 49.8%;
      left: 50%;
      transform: translate(-50%, -50%);
      height: 87vh;
      max-height: 800px;
      aspect-ratio: 9 / 19.5;
      width: auto;
      background: #FFF;
      border-radius: min(6vh, 58px);
      padding: 32px 16px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 2;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #backToHome {
      display: none;
      max-width: 360px;
      padding: 16px 0;
      position: sticky;
      top: -34px;
      left: 0;
      right: 0;
      z-index: 10;
      background: #FDFCFA;
      width: 100%;
      border-top-left-radius: 2vh;
      border-top-right-radius: 2vh;
      box-shadow: 0 2px 4px rgba(91, 114, 106, 0.08);
    }

    .chat {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 7%);
      z-index: 1000;
      padding: 12px 16px 30px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.65) 0%, #FFF 88.18%);
      border-bottom-left-radius: 6vh;
      border-bottom-right-radius: 6vh;
    }

    .popup-inner {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      /* max-width: 362px; */
      background: linear-gradient(180deg, rgba(184, 195, 191, 0.00) 0%, #B8C3BF 100%);
      backdrop-filter: blur(4px);
      padding: 32px 16px;
      text-align: center;
      border-bottom-left-radius: min(5vh, 58px);
      border-bottom-right-radius: min(5vh, 58px);
      z-index: 9999;
    }

    /* Chrome / Safari */
    .inner-page::-webkit-scrollbar {
      display: none;
    }

    .frame-wrapper {
      position: relative;
    }

    /* Custom Scrollbar */
    .custom-scrollbar {
      position: fixed;
      right: 16px;
      top: 35%;
      width: 12px;
      height: calc(100% - 20px);
      display: flex;
      justify-content: center;
      padding: 4px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: width 0.3s;
      height: 200px;
      border: 1px solid rgba(255, 255, 255, 0.50);
    }

    .scrollbar-thumb {
      position: absolute;
      width: 8px;
      margin: 2px 0;
      background: rgba(255, 255, 255, 0.70);
      border-radius: 10px;
      cursor: grab;
      transition: background 0.3s;
    }

    @media only screen and (max-width: 640px) {
      .main-wrapper {
        height: 100%;
      }

      .mobile-frame {
        height: auto;
        width: 100%;
      }

      .frame-wrapper {
        background-image: none;
      }

      .img-wrapper {
        display: none;
      }

      .inner-page {
        position: static;
        height: 100vh;
        transform: none;
        border-radius: 0;
        width: 100vw;
        max-height: 100vh;
        aspect-ratio: unset;
      }

      .chat {
         width: 100%;
        position: fixed;
        bottom: 0;
        padding: 12px 16px 16px;
      }

      .popup-inner {
        position: fixed;
        bottom: 0;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }

      .popup-inner {
        width: 100% !important;
      }

      #backToHome {
        top: 0;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        padding: 10px 16px;
      }

      #customScrollbar {
        display: none;
      }

    }

    @media only screen and (max-width: 392px) {
      .popup-inner {
        width: 100%;
      }
    }
  </style>
</head>

<body width="100%"
  style="font-family: 'Lora', Arial, sans-serif ; margin: 0; padding: 0 !important; mso-line-height-rule: exactly;">
  <center class="main-wrapper">
    <div class="frame-wrapper scroll-wrapper">
      <div class="img-wrapper">
        <img src="/image/titanium-frame.png" class="mobile-frame" alt="frame" />
      </div>

      <div class="inner-page content" id="content">
        <!-- back -->
        <div id="backToHome">
          <button type="button" style="cursor: pointer; border: none; background: none; margin-right: auto;"
            onclick="if (document.referrer) { history.back(); } else { window.location.href = '/'; }">
            <img src="/image/angle-left.png" alt="Left angle"
              style="width: 24px; height: auto; display: inline-block; vertical-align: middle; padding-right: 12px;" />
            <span
              style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle;">
              Go Home
            </span>
          </button>
        </div>
        <table align="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%"
          style="margin: auto;">

          <!-- section-1 -->
          <tr>
            <td align="center" valign="top">
              <table valign="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%"
                style="margin: auto;">
                <tr>
                  <td width="25%" valign="middle" style="padding: 4px 0;">
                    <a href="/" style="display: inline-block;">
                      <img src="/image/LOGO_Cross Conncet_Icon.svg" alt="Logo"
                        style="width: 32px; height: auto; display: block; vertical-align: middle;" />
                    </a>
                  </td>
                  <td width="25%" valign="middle" align="center">
                    <div style="padding-bottom: 2px;">
                      <img src="/image/chat-with-pete-black.png" alt="Chat with Pete"
                        style="width: 16px; height: auto; display: inline-block; vertical-align: middle; padding-right: 4px;" />
                      <span
                        style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle; margin: 0;">
                        Pete
                      </span>
                    </div>
                    <p id="todaysDate"
                      style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 12px; font-weight: 400; line-height: 16px; letter-spacing: 0.12px; color: #606161; display: inline-block; vertical-align: middle; margin: 0;">
                    </p>
                  </td>
                  <td width="25%" align="right" valign="middle" style="padding: 4px 0;">
                    <a href="#"
                      style="display: inline-block; padding: 4px 10px; border-radius: 24px; box-shadow: 0 4px 16px 0 rgba(91, 114, 106, 0.15); background-color: #647D74; text-decoration: none; color: #fff; font-family: 'Lora', Arial, san-serif; font-size: 12px; font-weight: 500; line-height: 16px; letter-spacing: 0.12px;">
                      Free Trial
                    </a>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- spacer -->
          <tr>
            <td style="padding-bottom: 20px"></td>
          </tr>

          <!-- section-2 -->
          <tr>
            <td valign="top" style="padding: 10px 0;">
              <button type="button" id="back" style="cursor: pointer; border: none;"
                onclick="if (document.referrer) { history.back(); } else { window.location.href = '/'; }">
                <img src="/image/angle-left.png" alt="Left angle"
                  style="width: 24px; height: auto; display: inline-block; vertical-align: middle; padding-right: 12px;" />
                <span
                  style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle; margin: 0;">
                  Go Home
                </span>
              </button>
            </td>
          </tr>

          <!-- spacer -->
          <tr>
            <td style="padding-bottom: 16px"></td>
          </tr>

          <!-- section-3 -->
          <tr>
            <td valign="top"
              style="padding: 12px; background-color: #fff; box-shadow: 0 1px 6px 0 rgba(91, 114, 106, 0.08); border-radius: 12px;">
              <p id="title"
                style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle; margin: 0;">
              </p>
            </td>
          </tr>

          <!-- spacer -->
          <tr>
            <td style="padding-bottom: 16px"></td>
          </tr>

          <!-- section-4 -->
          <tr>
            <td>
              <table valign="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%"
                style="margin: auto;">
                <tr>
                  <td width="10%"></td>
                  <td width="90%" valign="top"
                    style="padding: 12px; background-color: #F3EBE0; box-shadow: 0 1px 6px 0 rgba(91, 114, 106, 0.08); border-radius: 12px;">
                    <p id="human"
                      style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle; margin: 0;">
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- spacer -->
          <tr>
            <td style="padding-bottom: 16px"></td>
          </tr>

          <!-- section-5 -->
          <tr>
            <td>
              <table valign="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%"
                style="margin: auto;">
                <tr id="response">
                </tr>
              </table>
            </td>
          </tr>
          <!-- spacer -->
          <tr>
            <td style="padding-bottom: 40px"></td>
          </tr>
        </table>
      </div>

      <!-- chat -->
      <div class="chat">
        <button type="button" id="openPopup"
          style="font-family: 'Lora', Georgia, serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #606161; background: none; border: 1px solid #839790; width: 100%; cursor: pointer; padding: 0; text-align: left; background-color: #fff; padding: 12px 16px; border-radius: 12px;">
          Let's Chat...
        </button>
      </div>

      <!-- popup -->
      <div class="popup-inner" id="popup">

        <div
          style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
          <img src="/image/logo-white-bg.svg" style="width: 48px; height: auto; display: inline-block;" alt="logo" />
        </div>
        <p
          style="font-size: 18px; font-weight: 700; color: #181818; line-height: 22px; margin: 0 0 24px 0; letter-spacing: 0.18px;">
          Continue the conversation in <br /> our Cross Connect app.
        </p>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <a href="#"
            style="width: 100%; max-width: 150px; padding: 8px 16px; border-radius: 24px; font-size: 14px; font-weight: 700; line-height: 18px; text-decoration: none; display: inline-block; cursor: pointer; transition: all 0.3s ease; background-color: transparent; letter-spacing: 0.14px; color: #647D74; border: 2px solid #647D74;">
            Explore features
          </a>

          <a href="#"
            style="width: 100%; max-width: 150px; padding: 8px 16px; border-radius: 24px; font-size: 14px; font-weight: 700; line-height: 18px; text-decoration: none; display: inline-block; cursor: pointer; transition: all 0.3s ease; background-color: #647D74; letter-spacing: 0.14px; color: #ffffff; border: 2px solid transparent;">
            Download App
          </a>
        </div>
      </div>

      <!-- custom scrollbar -->
      <div class="custom-scrollbar" id="customScrollbar">
        <div class="scrollbar-thumb" id="scrollbarThumb"></div>
      </div>

    </div>
  </center>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Add required styles
      let style = document.createElement('style');
      style.textContent = `
      .after-content-exists {
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.3s ease;
        }
        .after-content-exists.show {
          opacity: 1;
          visibility: visible;
        }
      `;
      document.head.appendChild(style);

      // Create chat message HTML
      function createChatMessage(aiMessage) {
        return `<td style="padding: 12px; background-color: #fff; box-shadow: 0 1px 6px 0 rgba(91, 114, 106, 0.08); border-radius: 12px;">
                    <table valign="center" role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%"
                           style="margin: auto;" class="after-content-exists" >
                      <tr>
                        <td valign="top" style="padding-bottom: 16px;">
                          <p style="font-family: 'Lora', Georgia, serif, Arial, sans-serif; font-size: 16px; font-weight: 400; line-height: 20px; color: #181818; display: inline-block; vertical-align: middle; margin: 0;">
                             ${markdownToHtml(aiMessage)}
                          </p>
                        </td>
                      </tr>
                    </table>
                 </td>`;
      }


      // Load and display chat content
      fetch('/chat.json')
        .then(response => response.json())
        .then(data => {
          const urlParams = new URLSearchParams(window.location.search);
          const tag = urlParams.get('tag');
          const content = tag && data[tag] ? data[tag] : data.default;

          const chatContainer = document.querySelector('#response').parentElement;
          const title = document.querySelector('#title');
          const human = document.querySelector('#human');
          title.innerHTML = content.title;
          human.innerHTML = content.human;

          let originalContent = createChatMessage(content.ai);
          // Initialize streaming
          setTimeout(() => {
            const temp = document.createElement('div');
            temp.innerHTML = originalContent;

            // Save the structure but clear text content
            responseContainer.innerHTML = originalContent;
            const textNodes = extractTextNodes(responseContainer);

            // Hide all after-content-exists elements initially
            const afterContentElements = responseContainer.getElementsByClassName('after-content-exists');
            Array.from(afterContentElements).forEach(element => {
              element.classList.remove('show');
            });

            // Clear all text nodes
            textNodes.forEach(({ node }) => {
              node.textContent = '';
            });

            // Start typing animation
            typeText(textNodes);
          }, 500);

        })
        .catch(error => console.error('Error loading chat content:', error));


      // Function to convert markdown to HTML
      function markdownToHtml(markdown) {
        // Basic markdown conversion - expand as needed
        return markdown
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
          .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
          .replace(/\n\n/g, '</p><p>') // Paragraphs
          .replace(/\n/g, '<br>') // Line breaks
          .replace(/#{3} (.*)/g, '<h3>$1</h3>') // H3
          .replace(/#{2} (.*)/g, '<h2>$1</h2>') // H2
          .replace(/#{1} (.*)/g, '<h1>$1</h1>'); // H1
      }
      const openButton = document.getElementById('openPopup');
      const popup = document.getElementById('popup');
      const innerPage = document.querySelector('.inner-page');
      const backToHomeBtn = document.getElementById('backToHome');

      // Hide popup initially
      popup.style.display = 'none';

      // Rest of your existing event listeners
      openButton.addEventListener('click', function (e) {
        e.stopPropagation();
        popup.style.display = 'block';
      });

      innerPage.addEventListener('click', function (event) {
        if (!popupInner.contains(event.target)) {
          popup.style.display = 'none';
        }
      });

      // const backToHomeBtn = document.getElementById('backToHome');
      function handleScroll(scrollTop) {
        if (scrollTop >= 127) {
          backToHomeBtn.style.display = 'flex';
        } else {
          backToHomeBtn.style.display = 'none';
        }
      }

      // Initial state
      backToHomeBtn.style.display = 'none';

      // Attach event based on screen size
      function attachScrollHandler() {
        if (window.innerWidth > 640) {
          // Remove window scroll if exists
          window.removeEventListener('scroll', windowScrollHandler);
          // Add inner-page scroll
          innerPage.addEventListener('scroll', innerScrollHandler);
        } else {
          // Remove inner scroll if exists
          innerPage.removeEventListener('scroll', innerScrollHandler);
          // Add window scroll
          window.addEventListener('scroll', windowScrollHandler);
        }
      }

      // Define handlers
      function windowScrollHandler() {
        handleScroll(window.scrollY);
      }

      function innerScrollHandler() {
        handleScroll(innerPage.scrollTop);
      }

      // Attach initially
      attachScrollHandler();

      // Reattach on resize (when crossing 640px)
      window.addEventListener('resize', attachScrollHandler);

      const responseContainer = document.getElementById('response');
      const popupInner = document.querySelector('.popup-inner');

      // Function to extract text content from HTML elements
      function extractTextNodes(element, texts = []) {
        Array.from(element.childNodes).forEach(node => {
          if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
            texts.push({
              node: node,
              text: node.textContent
            });
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            extractTextNodes(node, texts);
          }
        });
        return texts;
      }

      // Function to check and show elements with content
      function checkAndShowElement(element) {
        if (element && element.textContent.trim().length > 0) {
          element.classList.add('show');
        }
      }

      // Modified typeText function to handle after-content elements
      function typeText(textNodes, currentNodeIndex = 0, currentCharIndex = 0) {
        if (currentNodeIndex >= textNodes.length) {
          // After typing is complete, check all after-content elements
          const afterContentElements = responseContainer.getElementsByClassName('after-content-exists');
          Array.from(afterContentElements).forEach(element => {
            checkAndShowElement(element);
          });
          return;
        }

        const { node, text } = textNodes[currentNodeIndex];

        if (currentCharIndex === 0) {
          node.textContent = '';
        }

        if (currentCharIndex < text.length) {
          node.textContent += text[currentCharIndex];

          // Check parent elements for after-content-exists class
          let currentElement = node.parentElement;
          while (currentElement) {
            if (currentElement.classList.contains('after-content-exists')) {
              checkAndShowElement(currentElement);
            }
            currentElement = currentElement.parentElement;
          }

          setTimeout(() => {
            typeText(textNodes, currentNodeIndex, currentCharIndex + 1);
          }, Math.random() * 20 + 10);
        } else {
          setTimeout(() => {
            typeText(textNodes, currentNodeIndex + 1, 0);
          }, 100);
        }
      }

      // today's date
      const d = new Date();
      const formattedDate = d.toLocaleString("en-US", { month: "short", day: "2-digit", year: "numeric" });
      document.getElementById('todaysDate').innerHTML = formattedDate;

      const frame = document.querySelector('.mobile-frame');
      const chat = document.querySelector('.chat');

      function syncChatWidth() {
        // Only apply width styles if screen is wider than 640px
        if (window.innerWidth > 640) {
          const frameWidth = frame.clientWidth;
          chat.style.width = `${frameWidth - 29}px`;
          popupInner.style.width = `${frameWidth - 29}px`;
        } else {
          // Reset to default/auto width on smaller screens
          chat.style.width = '';
          popupInner.style.width = '';
        }
      }

      window.addEventListener('load', syncChatWidth);
      window.addEventListener('resize', syncChatWidth);

      // custom scroll bar
      const content = document.getElementById('content');
      const scrollbar = document.getElementById('customScrollbar');
      const thumb = document.getElementById('scrollbarThumb');

      let isDragging = false;
      let startY = 0;
      let startScrollTop = 0;

      function updateScrollbar() {
        const scrollHeight = content.scrollHeight;
        const clientHeight = content.clientHeight;
        const scrollTop = content.scrollTop;

        // Calculate thumb height
        const thumbHeight = (clientHeight / scrollHeight) * scrollbar.clientHeight;
        thumb.style.height = thumbHeight + 'px';

        // Calculate thumb position
        const thumbTop = (scrollTop / scrollHeight) * scrollbar.clientHeight;
        thumb.style.top = thumbTop + 'px';

      }

      // Update scrollbar on content scroll
      content.addEventListener('scroll', updateScrollbar);

      // Thumb drag functionality
      thumb.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        startScrollTop = content.scrollTop;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const deltaY = e.clientY - startY;
        const scrollHeight = content.scrollHeight;
        const clientHeight = content.clientHeight;
        const scrollbarHeight = scrollbar.clientHeight;

        const scrollDelta = (deltaY / scrollbarHeight) * scrollHeight;
        content.scrollTop = startScrollTop + scrollDelta;
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      // Click on scrollbar track to jump
      scrollbar.addEventListener('click', (e) => {
        if (e.target === thumb) return;

        const rect = scrollbar.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const scrollbarHeight = scrollbar.clientHeight;
        const scrollHeight = content.scrollHeight;

        content.scrollTop = (clickY / scrollbarHeight) * scrollHeight;
      });

      // Initialize scrollbar
      updateScrollbar();

      // Update on window resize
      window.addEventListener('resize', updateScrollbar);
    });
  </script>
</body>

</html>